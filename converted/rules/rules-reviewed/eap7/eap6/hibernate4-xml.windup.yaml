metadata:
- description: "\n            This ruleset provides analysis of configuration migration
    to Hibernate 5.\n        "
  dependencies:
    addon:
    - id: org.jboss.windup.rules,windup-rules-javaee,2.4.0.Final
    - id: org.jboss.windup.rules,windup-rules-java,2.4.0.Final
  sourceTechnology:
  - id: hibernate
    versionRange: '[4,5)'
  - id: eap
    versionRange: '[6,7)'
  targetTechnology:
  - id: hibernate
    versionRange: '[5,)'
  - id: eap
    versionRange: '[7,)'
  tag:
  - hibernate
  - configuration
rules:
  rule:
  - when:
      filecontent:
      - pattern: hibernate.transaction.factory_class
        filename: hibernate.{file-ext}
    perform:
      hint:
      - message: "\n                        Replace configuration transaction property
          `hibernate.transaction.factory_class`\n                        with `hibernate.transaction.coordinator_class`.\n\n
          \                       Next the contract in `hibernate.transaction.coordinator_class`
          property should refer to `org.hibernate.resource.transaction.TransactionCoordinatorBuilder`\n
          \                       instead of to `org.hibernate.engine.transaction.spi.TransactionFactory`\n\n
          \                       If a JPA application does not provide a setting
          for `hibernate.transaction.coordinator_class`, Hibernate will automatically
          build the proper transaction coordinator based on the transaction type for
          the persistence unit.\n\n                        If a non-JPA application
          does not provide a setting for `hibernate.transaction.coordinator_class`,
          Hibernate will use jdbc as the default. This default will cause problems
          if the application actually uses JTA-based transactions. A non-JPA application
          that uses JTA-based transactions should explicitly set `hibernate.transaction.coordinator_class=jta`
          or provide a custom `org.hibernate.resource.transaction.TransactionCoordinatorBuilder`
          that builds a `org.hibernate.resource.transaction.TransactionCoordinator`
          that properly coordinates with JTA-based transactions.\n                        "
        link:
        - value: ""
          title: Hibernate 5 redesigned Transactions SPI
          href: https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/migration_guide/#migration_hibernate_orm_changes_transactions
        - value: ""
          title: Hibernate javadoc for org.hibernate.cfg.AvailableSettings.TRANSACTION_COORDINATOR_STRATEGY
          href: https://docs.jboss.org/hibernate/orm/5.1/javadocs/index.html?org/hibernate/cfg/AvailableSettings.html#TRANSACTION_COORDINATOR_STRATEGY
        tag:
        - hibernate
        - configuration
        - transaction
        quickfix:
        - replacement: hibernate.transaction.coordinator_class
          search: hibernate.transaction.factory_class
          type: REPLACE
          name: factory-property-qf
        - replacement: org.hibernate.resource.transaction.TransactionCoordinatorBuilder
          search: org.hibernate.engine.transaction.spi.TransactionFactory
          type: REPLACE
          name: factory-property-value-qf
        title: 'Hibernate: Deprecated property hibernate.transaction.factory_class'
        category-id: optional
        effort: 1
    where:
    - matches:
      - pattern: (cfg.xml|properties)
      param: file-ext
  - when:
      filecontent:
      - pattern: org.hibernate.id.{idclass}
        filename: '{*}.hbm.xml'
    perform:
      hint:
      - message: Use `org.hibernate.id.enhanced.SequenceStyleGenerator` instead.
        link:
        - value: ""
          title: Hibernate 5 Removed and deprecated classes
          href: https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/migration_guide/#migration_hibernate_orm_changes_deprecations
        tag:
        - hibernate
        title: Class org.hibernate.id.{idclass} was removed/deprecated in Hibernate
          5
        category-id: mandatory
        effort: 1
    where:
    - matches:
      - pattern: (TableGenerator|TableHiLoGenerator|SequenceGenerator|SequenceIdentityGenerator|SequenceHiLoGenerator)
      param: idclass
  - when:
      xmlfile:
      - matches: //generator/@class[windup:matches(self::node(), '{generator}')]
        in: '{*}.hbm.xml'
    perform:
      hint:
      - message: Identifier generator {generator} was removed/deprecated in Hibernate
          5. You can use `sequence` generator instead.
        link:
        - value: ""
          title: Hibernate 5 Removed and deprecated classes
          href: https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/migration_guide/#migration_hibernate_orm_changes_deprecations
        tag:
        - hibernate
        quickfix:
        - replacement: sequence
          search: seqhilo
          type: REPLACE
          name: id-qf1
        - replacement: sequence
          search: sequence-identity
          type: REPLACE
          name: id-qf2
        - replacement: sequence
          search: hilo
          type: REPLACE
          name: id-qf3
        title: Identifier generator {generator} was removed/deprecated in Hibernate
          5
        category-id: mandatory
        effort: 1
    where:
    - matches:
      - pattern: (seqhilo|sequence-identity|hilo)
      param: generator
  - when:
      or:
      - xmlfile:
        - as: cfg
          matches: //property[text() = 'org.hibernate.hql.spi.TemporaryTableBulkIdStrategy']
          in: hibernate.cfg.xml
        filecontent:
        - pattern: hibernate.hql.bulk_id_strategy=org.hibernate.hql.spi.TemporaryTableBulkIdStrategy
          filename: hibernate.properties
          as: properties
    perform:
      iteration:
      - hint:
        - message: Since Hibernate 5, the `org.hibernate.hql.spi.TemporaryTableBulkIdStrategy`
            class was replaced by `org.hibernate.hql.spi.id.global.GlobalTemporaryTableBulkIdStrategy`
            and `org.hibernate.hql.spi.id.local.LocalTemporaryTableBulkIdStrategy`.
          link:
          - value: ""
            title: Hibernate 5 Removed and deprecated classes
            href: https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/migration_guide/#migration_hibernate_orm_changes_deprecations
          tag:
          - hibernate
          - configuration
          quickfix:
          - replacement: org.hibernate.hql.spi.id.global.GlobalTemporaryTableBulkIdStrategy
            search: org.hibernate.hql.spi.TemporaryTableBulkIdStrategy
            type: REPLACE
            name: TemporaryTableBulkIdStrategy-qf1
          - replacement: org.hibernate.hql.spi.id.local.LocalTemporaryTableBulkIdStrategy
            search: org.hibernate.hql.spi.TemporaryTableBulkIdStrategy
            type: REPLACE
            name: TemporaryTableBulkIdStrategy-qf2
          title: TemporaryTableBulkIdStrategy was replaced in Hibernate 5
          category-id: mandatory
          effort: 1
        over: cfg
      - hint:
        - message: Since Hibernate 5, the `org.hibernate.hql.spi.TemporaryTableBulkIdStrategy`
            class was replaced by `org.hibernate.hql.spi.id.global.GlobalTemporaryTableBulkIdStrategy`
            and `org.hibernate.hql.spi.id.local.LocalTemporaryTableBulkIdStrategy`.
          link:
          - value: ""
            title: Hibernate 5 Removed and deprecated classes
            href: https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/migration_guide/#migration_hibernate_orm_changes_deprecations
          tag:
          - hibernate
          - configuration
          quickfix:
          - replacement: org.hibernate.hql.spi.id.global.GlobalTemporaryTableBulkIdStrategy
            search: org.hibernate.hql.spi.TemporaryTableBulkIdStrategy
            type: REPLACE
            name: TemporaryTableBulkIdStrategy-qf1
          - replacement: org.hibernate.hql.spi.id.local.LocalTemporaryTableBulkIdStrategy
            search: org.hibernate.hql.spi.TemporaryTableBulkIdStrategy
            type: REPLACE
            name: TemporaryTableBulkIdStrategy-qf2
          title: TemporaryTableBulkIdStrategy was replaced in Hibernate 5
          category-id: mandatory
          effort: 1
        over: properties
  - when:
      or:
      - xmlfile:
        - as: cfg
          matches: //property[text() = 'org.hibernate.hql.spi.PersistentTableBulkIdStrategy']
          in: hibernate.cfg.xml
        filecontent:
        - pattern: hibernate.hql.bulk_id_strategy=org.hibernate.hql.spi.PersistentTableBulkIdStrategy
          filename: hibernate.properties
          as: properties
    perform:
      iteration:
      - hint:
        - message: Since Hibernate 5, the `org.hibernate.hql.spi.PersistentTableBulkIdStrategy`
            class was moved to new package and you should use it as `org.hibernate.hql.spi.id.persistent.PersistentTableBulkIdStrategy`.
          link:
          - value: ""
            title: Other Hibernate ORM 5 changes
            href: https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/migration_guide/#migration_hibernate_orm_changes_miscellaneous
          tag:
          - hibernate
          - configuration
          quickfix:
          - replacement: org.hibernate.hql.spi.id.persistent.PersistentTableBulkIdStrategy
            search: org.hibernate.hql.spi.PersistentTableBulkIdStrategy
            type: REPLACE
            name: PersistentTableBulkIdStrategy-qf1
          title: Class PersistentTableBulkIdStrategy was moved in Hibernate 5
          category-id: mandatory
          effort: 1
        over: cfg
      - hint:
        - message: Since Hibernate 5, the `org.hibernate.hql.spi.PersistentTableBulkIdStrategy`
            class was moved to new package and you should use it as `org.hibernate.hql.spi.id.persistent.PersistentTableBulkIdStrategy`.
          link:
          - value: ""
            title: Other Hibernate ORM 5 changes
            href: https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/migration_guide/#migration_hibernate_orm_changes_miscellaneous
          tag:
          - hibernate
          - configuration
          quickfix:
          - replacement: org.hibernate.hql.spi.id.persistent.PersistentTableBulkIdStrategy
            search: org.hibernate.hql.spi.PersistentTableBulkIdStrategy
            type: REPLACE
            name: PersistentTableBulkIdStrategy-qf2
          title: Class PersistentTableBulkIdStrategy was moved in Hibernate 5
          category-id: mandatory
          effort: 1
        over: properties
sourceFile: http://github.com/windup/windup-rulesets/tree/master/rules/rules-reviewed/eap7/eap6/hibernate4-xml.windup.xml
